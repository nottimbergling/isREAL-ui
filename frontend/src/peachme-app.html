<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/app-menu/app-menu.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="../src/tweet-box.html">

<dom-module id="peachme-app">
    <template>
        <style include="shared-styles">
            :host {
                --app-primary-color: #FF5722;
                --app-secondary-color: white;
            }

            iron-pages {
                padding: 10px;
            }

            app-header {
                color: var(--app-secondary-color);
                background-color: var(--app-primary-color);
            }

            paper-icon-button + [main-title] {
                margin-left: 24px;
            }

            paper-progress {
                display: block;
                width: 100%;
                --paper-progress-active-color: rgba(255, 255, 255, 0.5);
                --paper-progress-container-color: transparent;
            }


            app-drawer {
                --app-drawer-scrim-background: rgba(0, 0, 0, 0.2);
                --app-drawer-content-container: {
                    background-color: #ffffff;
                }
            }


            app-menu {
                --app-menu-color: #616161;
                --primary-color: var(--app-primary-color);
                --app-menu-selected-bg-color: rgba(0, 0, 0, 0.05);
            }

            .drawer-menu-text {
                font-size: 16px;
            }

            .drawer-image {
                margin-top: 30px;
                margin-left: 52px;
                margin-bottom: 20px;
                width: 150px;
                height: 150px;
            }
        </style>

        <tweet-box tweetid="463440424141459456"></tweet-box>
    </template>

    <script>

        let Events = {
            fire: function(that, eventType, data){
                that.dispatchEvent(new CustomEvent(eventType, {
                    detail: data,
                    bubbles: true,
                    composed: true}
                ));
            },
            subscribe: function(that, eventType, callback){
                that.addEventListener(eventType, e => callback(e.detail));
            },
            isLoading: 'isLoading',
            isProfileEditMode: 'isProfileEditMode',
            search: 'search',

            // Globals Changing
            Globals: {
                subrouteChanged: 'routeChanged',
                userChanged: 'userChanged'
            }
        };


        let Globals = {
            subroute: {
                _val: {
                    prefix: "",
                    path: ""
                },
                set: (value) => {
                    Globals.subroute._val = value;
                    Events.fire(this, Events.Globals.subrouteChanged, value);
                },
                get: () => {
                    return Globals.subroute._val;
                }
            },
            user: {
                _val: "dddave",
                set: (value) => {
                    Globals.user._val = value;
                    Events.fire(this, Events.Globals.userChanged, value);
                },
                get: () => {
                    return Globals.user._val;
                }
            }
        };

        class PeachmeApp extends Polymer.Element {

            static get is() {
                return 'peachme-app';
            }

            static get properties() {
                return {
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_pageChanged',
                    },
                    rootPattern: String,
                    routeData: Object,
                    subroute: String,
                    isLoading: {
                        type: Boolean,
                        reflectToAttribute: true,
                        value: false
                    },
                    user: {
                        type: String,
                        value: Globals.user.get()
                    }
                };
            }

            static get observers() {
                return [
                    '_routePageChanged(routeData.page)',
                ];
            }

            constructor() {
                super();

                // Get root pattern for app-route, for more info about `rootPath` see:
                // https://www.polymer-project.org/2.0/docs/upgrade#urls-in-templates
                this.rootPattern = (new URL(this.rootPath)).pathname;
            }

            ready(){
                super.ready();
                Events.subscribe(this, Events.isLoading, (e) => {
                    this.isLoading = e.loading;
                });
            }

            _toggleDrawer(){
                this.$.drawer.toggle();
            }

            _routePageChanged(page) {
                // Polymer 2.0 will call with `undefined` on initialization.
                // Ignore until we are properly called with a string.
                if (page === undefined) {
                    return;
                }

                // If no page was found in the route data, page will be an empty string.
                // Default to 'search' in that case.
                this.page = page || 'search';

                // Close a non-persistent drawer when the page & route are changed.
                if (!this.$.drawer.persistent) {
                    this.$.drawer.close();
                }
            }

            _pageChanged(page) {
                Globals.subroute.set({
                    prefix: this.subroute.prefix,
                    path: this.subroute.path
                });

                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl('page-' + page + '.html');
                Polymer.importHref(
                    resolvedPageUrl,
                    null,
                    this._showPage404.bind(this),
                    true);
            }

            _showPage404() {
                this.page = '404';
            }
        }

        window.customElements.define(PeachmeApp.is, PeachmeApp);
    </script>
</dom-module>

